<!DOCTYPE html>
<html>
<head>
    <!-- æ·»åŠ  viewport meta æ ‡ç­¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="utf-8">
    <title>Educational Writing Correction System</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container-wrapper">
        <!-- å·¦ä¾§å¯¹è¯æ¡†å®¹å™¨ -->
        <div class="chat-container" id="chatContainer2">
            <div class="chat-title-left">
                <span class="visualization-text" id = "title">Educational Writing Correction System</span>
                
                <button class = "editImg" id = "rotateBtn" >Rotate</button>
                <button class = "editImg" id = "cropBtn" >Crop</button>
                <button class = "editImg" id = "exportBtn" >Export</button>

                <div class="onoffswitch">
                    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch">
                    <label class="onoffswitch-label" for="myonoffswitch">
                        <span class="onoffswitch-inner"></span>
                        <span class="onoffswitch-switch"></span>
                    </label>
                    
                </div>
            </div>
            <div class="image-container" id="imageContainer">
                <!-- åŸå§‹å›¾åƒ -->
             
                <!-- ç”¨äºç»˜åˆ¶çº¿æ¡çš„ Canvas -->
                <canvas id="canvasOverlay" class="overlay-canvas" ></canvas>
            </div>
        </div>
    </div>
    <div>
        <div class="input-box">
            <div class="lang-switch">
                <span class="icon">ğŸŒ</span>
                <span id="en" class="lang-option active">English</span>
                <span id="zh" class="lang-option">ç®€ä¸­</span>
              </div>
            <input type="file" id="uploadImage" accept="image/*">
            <button class="upload-btn" id="uploadBtn">Click to upload a file</button>
            <span id ="fileName"></span>
            <!-- <button id="sendMessage">Send</button>
            <button id="enableDetection">å¼€å¯æ£€æµ‹</button> -->
            <div class="case-box">
                <button data-file="case1.png" class="case" id = "template1">template 1</button>
                <button data-file="case2.jpg" class="case" id = "template2">template 2</button>
                <button data-file="case3.png" class="case" id = "template3">template 3</button>
                <button data-file="case4.jpg" class="case" id = "template4">template 4</button>
                <button data-file="case5.jpg" class="case" id = "template5">template 5</button>
                <button data-file="case6.jpg" class="case" id = "template6">template 6</button>
            </div>
            <div class="progress-control">
                <input type="range" id="editProgress" min="0" max="100" value="0" class="progress-slider">
                <div class="progress-text">
                    <span id="progress">Edit progress: </span>
                    <span id="progressValue">0%</span>
                </div>
            </div>
        <!-- ç”¨äºæ˜¾ç¤º correct_info ä¿¡æ¯çš„å®¹å™¨ -->
        <div id="infoContainer" class="info-container"></div>
    </div>

  <!-- è£å‰ªå¼¹çª— -->
  <div id="cropOverlay">
    <canvas id="cropCanvas"></canvas>
    <button id="cropDoneBtn">è£å‰ªå®Œæˆ</button>
  </div>

<!-- å¤„ç† -->
<div id="toast">
    <div id="spinner"></div>
    <span id="toastText"></span>
  </div>

</div>

<script>
    

    function calculate(original) {
    
    const originalWidth = img.width;
    return 890/img.width*original;
    };
    

    document.querySelector('.onoffswitch-checkbox').addEventListener('change', function(e) {
        if (this.checked) {
            console.log('Switch is ON');
        } else {
            console.log('Switch is OFF');
        }
    });

    let correctInfo = null; // çº æ­£ä¿¡æ¯ 
    let currentImageFile = null; // å½“å‰å¤„ç†çš„å›¾ç‰‡æ–‡ä»¶
    let originalImageSrc = null; // åŸå§‹å›¾ç‰‡çš„ DataURL
    let correctedImage = null; // çº æ­£åçš„å›¾ç‰‡
    let isCorrectedFetched = false; // æ˜¯å¦å·²è·å–çº æ­£åçš„å›¾åƒ

    let correctInfoTemp = [   // æµ‹è¯•1
    {
        "correct_id": 0,
        "fk_error_id": null,
        "img_box": [
            {
                "method1": {
                    "delete_line": {
                        "end_x": 292,
                        "end_y": 302,
                        "start_x": 268,
                        "start_y": 302
                    }
                },
                "method2": {
                    "delete_box": {
                        "end_x": 292,
                        "end_y": 315,
                        "start_x": 268,
                        "start_y": 289
                    }
                }
            }
        ],
        "img_mark_type": "delete",
        "modified_result": "-NONE-"
    },
    {
        "correct_id": 1,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 371,
                "end_y": 314,
                "start_x": 347,
                "start_y": 288
            }
        ],
        "img_mark_type": "edit",
        "modified_result": "å‡æœŸ"
    },
    {
        "correct_id": 2,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 522,
                "end_y": 279,
                "start_x": 522,
                "start_y": 252
            }
        ],
        "img_mark_type": "add",
        "modified_result": "æ—¶å€™"
    },
    {
        "correct_id": 3,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 369,
                "end_y": 388,
                "start_x": 369,
                "start_y": 360
            }
        ],
        "img_mark_type": "add",
        "modified_result": "ï¼Œ"
    },
    {
        "correct_id": 4,
        "fk_error_id": null,
        "img_box": [
            {
                "method1": {
                    "delete_line": {
                        "end_x": 584,
                        "end_y": 662,
                        "start_x": 538,
                        "start_y": 662
                    }
                },
                "method2": {
                    "delete_box": {
                        "end_x": 584,
                        "end_y": 675,
                        "start_x": 538,
                        "start_y": 650
                    }
                }
            }
        ],
        "img_mark_type": "delete",
        "modified_result": "-NONE-"
    },
    {
        "correct_id": 5,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 120,
                "end_y": 62,
                "start_x": 120,
                "start_y": 38
            }
        ],
        "img_mark_type": "add",
        "modified_result": "ï¼Œ"
    },
    {
        "correct_id": 6,
        "fk_error_id": null,
        "img_box": [
            {
                "method1": {
                    "delete_line": {
                        "end_x": 211,
                        "end_y": 158,
                        "start_x": 136,
                        "start_y": 158
                    }
                },
                "method2": {
                    "delete_box": {
                        "end_x": 211,
                        "end_y": 169,
                        "start_x": 136,
                        "start_y": 147
                    }
                }
            }
        ],
        "img_mark_type": "delete",
        "modified_result": "-NONE-"
    },
    {
        "correct_id": 7,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 313,
                "end_y": 494,
                "start_x": 284,
                "start_y": 468
            }
        ],
        "img_mark_type": "edit",
        "modified_result": "å¹¿åœº"
    },
    {
        "correct_id": 8,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 266,
                "end_y": 566,
                "start_x": 244,
                "start_y": 541
            }
        ],
        "img_mark_type": "edit",
        "modified_result": "å‡‹"
    },
    {
        "correct_id": 9,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 506,
                "end_y": 638,
                "start_x": 485,
                "start_y": 614
            }
        ],
        "img_mark_type": "edit",
        "modified_result": "ä¼‘"
    },
    {
        "correct_id": 10,
        "fk_error_id": null,
        "img_box": [
            {
                "method1": {
                    "delete_line": {
                        "end_x": 371,
                        "end_y": 409,
                        "start_x": 311,
                        "start_y": 409
                    }
                },
                "method2": {
                    "delete_box": {
                        "end_x": 371,
                        "end_y": 422,
                        "start_x": 311,
                        "start_y": 397
                    }
                }
            }
        ],
        "img_mark_type": "delete",
        "modified_result": "-NONE-"
    }
]
    

    // æ›´æ–° Canvas å°ºå¯¸ä»¥é€‚åº”å›¾åƒå¤§å°
    function updateCanvasSize(imageElement) {
        if (canvas) {
            canvas.width = imageElement.clientWidth;
            canvas.height = imageElement.clientHeight;
            console.log('Canvas width:', canvas.width, 'Canvas height:', canvas.height);
        } else {
            console.error('Canvas element not found!');
        }
    }
    // æ¸…ç©º Canvas ç»˜åˆ¶å†…å®¹
    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    const progressSlider = document.getElementById('editProgress');
    const progressValue = document.getElementById('progressValue'); 
    // function frawlines(correctInfo)
    let canvas = document.getElementById('canvasOverlay');
    let ctx = canvas.getContext('2d');
    
    // ç”»çº¿
    function drawLines(correctInfo) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
            // è®¾ç½® canvas çš„å®½é«˜å’Œå›¾ç‰‡ä¸€è‡´
             canvas.width = calculate(img.width);
             canvas.height = calculate(img.height);

             // å°†å›¾ç‰‡ç»˜åˆ¶åˆ° canvas ä¸Š
             ctx.drawImage(img, 0, 0,canvas.width,canvas.height);
                 
                
        //*********************************ls
        const progress = parseInt(progressSlider.value);
        const showCount = Math.ceil(correctInfo.length * progress / 100);
        console.log('Drawing test shape...');
        // ctx.strokeStyle = 'blue';
        // ctx.lineWidth = 5;
        // ctx.beginPath();
        // ctx.moveTo(0, 0);
        // ctx.lineTo(100, 100);
        // ctx.stroke(); // ç»˜åˆ¶ä¸€æ¡çº¿è¿›è¡Œæµ‹è¯•
        // console.log('Canvas width:', canvas.width, 'Canvas height:', canvas.height);
        // console.log('Canvas ctx',ctx)
        // console.log('correctInfo:', correctInfo); // è°ƒè¯•è¾“å‡º
        // ctx.fillStyle = 'red';
        // ctx.fillRect(10, 10, 50, 50); // åœ¨ Canvas ä¸Šç»˜åˆ¶ä¸€ä¸ªçº¢è‰²æ–¹å—
        // correctInfoTest = [{'correct_id': 0, 'img_box': [{'start_x': 361, 'start_y': 289, 'end_x': 361, 'end_y': 314}], 'modified_result': 'å‡æœŸ', 'img_mark_type': 'add', 'fk_error_id': None}, {'correct_id': 1, 'img_box': [{'start_x': 522, 'start_y': 252, 'end_x': 522, 'end_y': 279}], 'modified_result': 'æ—¶é—´', 'img_mark_type': 'add', 'fk_error_id': None}, {'correct_id': 2, 'img_box': [{'start_x': 369, 'start_y': 360, 'end_x': 369, 'end_y': 388}], 'modified_result': 'ï¼Œ', 'img_mark_type': 'add', 'fk_error_id': None}, {'correct_id': 3, 'img_box': [{'method1': {'delete_line': {'start_x': 136, 'start_y': 158, 'end_x': 211, 'end_y': 158}}, 'method2': {'delete_box': {'start_x': 136, 'start_y': 147, 'end_x': 211, 'end_y': 169}}}], 'modified_result': '-NONE-', 'img_mark_type': 'delete', 'fk_error_id': None}, {'correct_id': 4, 'img_box': [{'start_x': 284, 'start_y': 468, 'end_x': 313, 'end_y': 494}], 'modified_result': 'æ± å¡˜', 'img_mark_type': 'edit', 'fk_error_id': None}, {'correct_id': 5, 'img_box': [{'start_x': 244, 'start_y': 541, 'end_x': 266, 'end_y': 566}], 'modified_result': 'å‡‹', 'img_mark_type': 'edit', 'fk_error_id': None}, {'correct_id': 6, 'img_box': [{'start_x': 485, 'start_y': 614, 'end_x': 506, 'end_y': 638}], 'modified_result': 'ä¼‘', 'img_mark_type': 'edit', 'fk_error_id': None}, {'correct_id': 7, 'img_box': [{'method1': {'delete_line': {'start_x': 311, 'start_y': 409, 'end_x': 371, 'end_y': 409}}, 'method2': {'delete_box': {'start_x': 311, 'start_y': 397, 'end_x': 371, 'end_y': 422}}}], 'modified_result': '-NONE-', 'img_mark_type': 'delete', 'fk_error_id': None}];
        for (let i = 0; i < showCount; i++) {
        const item = correctInfo[i];
       
            const { img_mark_type, img_box, modified_result } = item;
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.fillStyle = 'red';
            ctx.font = '16px Arial';
            console.log('Drawing test shape...');

            if (img_mark_type === 'add') {
    // å¤„ç†â€œæ·»åŠ â€æ ‡è®°
            if (Array.isArray(img_box) && img_box.length === 1) {
            let { start_x, start_y, end_x, end_y } = img_box[0];

               start_x = calculate(start_x);
               start_y = calculate(start_y);
               end_x = calculate(end_x);
               end_y = calculate(end_y);
               ctx.beginPath();
               ctx.moveTo(start_x, start_y);
               ctx.lineTo(end_x, end_y);
               ctx.strokeStyle = 'red';  // å¯ä»¥ç”¨ç»¿è‰²è¡¨ç¤ºâ€œæ·»åŠ â€
               ctx.stroke();

               ctx.font = "16px Arial";
               ctx.fillStyle = "red";
               ctx.fillText(modified_result, start_x, start_y - 10);
    } else {
        console.error('Invalid img_box structure for add mark:', img_box);
    }
}


    else if (img_mark_type === 'delete') {
    if (Array.isArray(img_box)) {
        img_box.forEach(box => {
            if (
                typeof box === 'object' &&
                box !== null &&
                box.method1 &&
                box.method1.delete_line
            ) {
                let { start_x, start_y, end_x, end_y } = box.method1.delete_line;
                start_x = calculate(start_x);
                start_y = calculate(start_y);
                end_x = calculate(end_x);
                end_y = calculate(end_y);
                ctx.beginPath();
                ctx.moveTo(start_x, start_y);
                ctx.lineTo(end_x, end_y);
                ctx.strokeStyle = 'red'; // å¯é€‰ï¼šè®¾ç½®åˆ é™¤çº¿é¢œè‰²
                ctx.stroke();
            } 
            else {
                console.error('Invalid box structure for delete mark:', box);
            }
            if (
                typeof box === 'object' &&
                box !== null &&
                box.method2 &&
                box.method2.delete_box
            ) {
                let { start_x, start_y, end_x, end_y } = box.method2.delete_box;
                start_x = calculate(start_x);
                start_y = calculate(start_y);
                end_x = calculate(end_x);
                end_y = calculate(end_y);
                ctx.strokeStyle = 'red';
                ctx.strokeRect(start_x, start_y, end_x - start_x, end_y - start_y);

                // å¯é€‰ï¼šåœ¨æ¡†ä¸‹æ–¹å†™æ–‡å­—è¯´æ˜
                ctx.font = "14px Arial";
                ctx.fillStyle = "red";
               
            }
        });
                } else {
                    console.error('Invalid img_box structure for delete mark:', img_box);
                }
            } 


            else if (img_mark_type === 'edit') {
                if (Array.isArray(img_box)) {
                    
                    img_box.forEach((box, index) => {
                        // console.log('Processing edit mark with box:', box);
                        let { start_x, start_y, end_x, end_y } = box; // ä½¿ç”¨è§£æ„èµ‹å€¼æ¥è·å–å¯¹è±¡å±æ€§
                        start_x = calculate(start_x);
                        start_y = calculate(start_y);
                        end_x = calculate(end_x);
                        end_y = calculate(end_y);
                        ctx.strokeRect(start_x, start_y, end_x - start_x, end_y - start_y);
                        ctx.fillText(modified_result, start_x +(end_x - start_x), end_y+15);
                        console.log(modified_result);
                    });
                } else {
                    console.error('Invalid img_box structure for edit mark:', img_box);
                }
            } else if (img_mark_type === 'word-order') {
                // å¤„ç†â€œå­—åºâ€æ ‡è®°
                if (Array.isArray(img_box)) {
                    const method1 = img_box[0].method1;
                    let { bottom, right, top } = method1;
                    bottom = calculate(bottom);
                    right= calculate(right);
                    top = calculate(top);

                    // console.log('Line details for word-order mark:', { bottom, right, top });
                    ctx.beginPath();
                    // ç»˜åˆ¶é¡¶éƒ¨çº¿
                    ctx.moveTo(top.x1, top.y1);
                    ctx.lineTo(top.x2, top.y2);
                    // ç»˜åˆ¶å³ä¾§çº¿
                    ctx.moveTo(right.x1, right.y1);
                    ctx.lineTo(right.x2, right.y2);
                    // ç»˜åˆ¶åº•éƒ¨çº¿
                    ctx.moveTo(bottom.x1, bottom.y1);
                    ctx.lineTo(bottom.x2, bottom.y2);
                    ctx.stroke();}
                else {
                    console.error('Invalid img_box structure for word-order mark:', img_box);
                }
            } else {
                console.error('Unknown img_mark_type:', img_mark_type);
            }
          }
};
    progressValue.textContent = '0%';
    progressSlider.addEventListener('input', function() {
    progressValue.textContent = this.value + '%';
    drawLines(correctInfo);
   
});

    let img = new Image();
    let currentImg = new Image();

    // ä¸Šä¼ 
    document.getElementById('uploadBtn').addEventListener('click', () => { // 
        uploadImage.click();
        
    });

    uploadImage.addEventListener("change", () => {
      if (uploadImage.files.length > 0) {
        fileName.textContent = uploadImage.files[0].name;
      } else {
        // åˆ¤æ–·ç›®å‰èªè¨€
        if (enBtn.classList.contains("active")) {
          fileName.textContent = texts.en.nofile;
        } else {
          fileName.textContent = texts.zh.nofile;
        }
      }

      const imageFile = document.getElementById('uploadImage').files[0];
        if (imageFile) {
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            // document.getElementById('imageContainer').innerHTML = '';

            // const infoContainer = document.getElementById('infoContainer');
            // infoContainer.innerHTML = '';
            // infoContainer.style.display = 'none';

            // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
            const reader = new FileReader();
            console.log(reader);
            reader.onload = (event) => {
                originalImageSrc = event.target.result;
                //  document.getElementById('imageContainer').innerHTML = `<img src="${originalImageSrc}"  id="originalImage" class="corrected-image">`;
                
                // *****************************ls
                const canvas = document.getElementById('canvasOverlay');
                const ctx = canvas.getContext('2d');
                img.src =  originalImageSrc;
                
                img.onload = function() {
                  // è®¾ç½® canvas çš„å®½é«˜å’Œå›¾ç‰‡ä¸€è‡´
                  canvas.width = calculate(img.width);
                  canvas.height = calculate(img.height);
                  console.log(img.width);
                 // å°†å›¾ç‰‡ç»˜åˆ¶åˆ° canvas ä¸Š
                  ctx.drawImage(img, 0, 0,canvas.width,canvas.height);
                  currentImg = img;
                };
            };

            reader.onerror = (error) => {
                alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                console.error('File reading error:', error);
            };

            reader.readAsDataURL(imageFile);

            // æ›´æ–°å½“å‰å›¾ç‰‡æ–‡ä»¶
            currentImageFile = imageFile;

            // é‡ç½®å¼€å…³çŠ¶æ€
            document.getElementById('myonoffswitch').checked = false;
            clearCanvas();
            correctedImage = null;
            correctInfo = null;
            isCorrectedFetched = false;
        }
    });


    // caseSolution
    document.querySelectorAll('.case').forEach(button => {
        
        button.addEventListener('click', async () => {
        const fileName = button.dataset.file;  // è·å– data-file
        if (!fileName) {
            console.error("æŒ‰é’®æ²¡æœ‰æŒ‡å®šæ–‡ä»¶åï¼");
            return;
        }
    try {
        // è¯·æ±‚åç«¯å›¾ç‰‡
        const response = await fetch(`http://127.0.0.1:5000/get_image/${fileName}`, {
            method: "GET"
    });
        const blob = await response.blob();

        // è½¬æˆ File å¯¹è±¡
        const imageFile = new File([blob], "575.jpg", { type: blob.type });
        console.log("å¾—åˆ° imageFile:", imageFile);

        if (imageFile) {
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            // document.getElementById('imageContainer').innerHTML = '';

            // const infoContainer = document.getElementById('infoContainer');
            // infoContainer.innerHTML = '';
            // infoContainer.style.display = 'none';

            // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
            const reader = new FileReader();
            console.log(reader);
            reader.onload = (event) => {
                originalImageSrc = event.target.result;
                //  document.getElementById('imageContainer').innerHTML = `<img src="${originalImageSrc}"  id="originalImage" class="corrected-image">`;
                // *****************************ls
                const canvas = document.getElementById('canvasOverlay');
                const ctx = canvas.getContext('2d');

                img.src =  originalImageSrc;
                img.onload = function() {
                  // è®¾ç½® canvas çš„å®½é«˜å’Œå›¾ç‰‡ä¸€è‡´
                  console.log("å¾—åˆ° imageFile:",img.width,img.height,imageFile);
                  canvas.width = calculate(img.width);
                  canvas.height = calculate(img.height);
                  console.log(img.width);
                 // å°†å›¾ç‰‡ç»˜åˆ¶åˆ° canvas ä¸Š
                  ctx.drawImage(img, 0, 0,canvas.width,canvas.height);
                };
                //*********************************ls
            };

            reader.onerror = (error) => {
                alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                console.error('File reading error:', error);
            };

            reader.readAsDataURL(imageFile);

            // æ›´æ–°å½“å‰å›¾ç‰‡æ–‡ä»¶
            currentImageFile = imageFile;

            // é‡ç½®å¼€å…³çŠ¶æ€
            document.getElementById('myonoffswitch').checked = false;
            clearCanvas();
            correctedImage = null;
            correctInfo = null;
            isCorrectedFetched = false;
        }
    } catch (err) {
        console.error("è·å–å›¾ç‰‡å¤±è´¥:", err);
        alert("è·å–å›¾ç‰‡å¤±è´¥ï¼");
    }
    });
});



// 
const toast = document.getElementById('toast');
const spinner = document.getElementById('spinner');
const toastText = document.getElementById('toastText');

function showLoading() {
    toast.style.display = 'flex';
    toast.classList.add('show'); // æ»‘å…¥åŠ¨ç”»
    spinner.style.display = 'inline-block';
    toastText.textContent = 'Processing...';
    toastText.style.color = '#333';
}

function showResult(text, color = 'green') {
    spinner.style.display = 'none';
    toastText.textContent = text;
    toastText.style.color = color;

    setTimeout(() => {
        toast.classList.remove('show'); // å¼€å§‹æ»‘å‡º
        setTimeout(() => {
            toast.style.display = 'none';
            toastText.style.color = '#333'; // é‡ç½®é¢œè‰²
        }, 300); // ç­‰å¾…æ»‘å‡ºåŠ¨ç”»ç»“æŸ
    }, 1500); // æ˜¾ç¤º 1.5 ç§’åæ¶ˆå¤±
}

    // è°ƒç”¨ API è·å–çº æ­£åçš„å›¾åƒ
    function fetchCorrectedImage(imageFile) {
        console.log('imageFile',imageFile);
        if (imageFile) {
            console.log('Fetching corrected image for:', imageFile);
            const formData = new FormData();
            formData.append('image', imageFile);
            const api = 'http://127.0.0.1:5000/img_correct';
            showLoading();
            // æµ‹è¯•1
            fetch(api, {
                method: 'POST',
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    correctInfo = data.correct_info;
                    isCorrectedFetched = true;
                    document.getElementById('infoContainer').style.display = 'block'; // ä¿®æ”¹2
                    if (document.getElementById('myonoffswitch').checked) {
                        
                        console.log("hey");
                        console.log(correctInfo);
                        displayCorrectInfo(correctInfo);
                        progressSlider.value = 100;// ä¿®æ”¹2
                        progressValue.textContent = '100%'; // ä¿®æ”¹2
                        drawLines(correctInfo);
                        showResult('OK', 'green');

                        // é«˜äº®
                        const canvas = document.getElementById("canvasOverlay");
    // åˆ’å®šåŒºåŸŸ
        // ä¿å­˜æ‰€æœ‰çŸ©å½¢åŒºåŸŸ

console.log("testing")
correctInfo.forEach(item => {
  item.img_box.forEach(box => {
    let coordsList = [];

     // å¦‚æœ box é‡Œæœ‰ method1 æˆ– method2ï¼Œå°±å–é‡Œé¢çš„å€¼ï¼ˆæ’é™¤ undefinedï¼‰
    if (box.method2) {
      if (box.method2.delete_line) coordsList.push(box.method2.delete_line);
      if (box.method2.delete_box) coordsList.push(box.method2.delete_box);
    }

    // å¦‚æœæ˜¯ç›´æ¥åæ ‡å¯¹è±¡
    if (box.start_x !== undefined) {
      coordsList.push(box);
    }

    // ç»Ÿä¸€å­˜åˆ° regions
    coordsList.forEach(coords => {
        
    let { start_x, start_y, end_x, end_y } = coords;
    start_x = calculate(start_x);
    start_y = calculate(start_y);
    end_x = calculate(end_x);
    end_y = calculate(end_y);
    if (start_x == end_x){
        start_x -= 10;
        end_x += 10;
    }
    regions.push({
        correct_id: item.correct_id,
        x1: Math.min(start_x, end_x),
        y1: Math.min(start_y, end_y),
        x2: Math.max(start_x, end_x),
        y2: Math.max(start_y, end_y)
      });
    });
    });
    });
    console.log(regions);



    canvas.addEventListener("mousemove", handleMouseMove);
    console.log("å·²å¼€å¯é¼ æ ‡æ£€æµ‹");
    console.log(canvas.style.display, canvas.width, canvas.height);


                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('å›¾åƒçº é”™æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
                    document.getElementById('myonoffswitch').checked = false;
                    showResult('FAILURE', 'red');
                });

            // æµ‹è¯•1
            // correctInfo = correctInfoTemp
            // isCorrectedFetched = true;
            // document.getElementById('infoContainer').style.display = 'block';
            // displayCorrectInfo(correctInfo);
            // progressSlider.value = 100;
            // progressValue.textContent = '100%';
            // drawLines(correctInfo);
            // showResult('OK', 'green');

            
        }
    }

    // addded by charlie
    function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.display = 'block';
    
    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000); // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
} 

    // å¼€å§‹çº é”™
    document.getElementById('myonoffswitch').addEventListener('change', (event) => {
        console.log('Switch changed:', event.target.checked);
        // Check if the current image file is selected
        const imageFile = currentImageFile
        if (!imageFile) {
            alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
            return; // Exit if no image is selected
        }
        if (event.target.checked) {
            console.log('Switch is on');
            if (currentImageFile === document.getElementById('uploadImage').files[0]) {
                if (isCorrectedFetched && correctInfo) {
                    console.log('Using cached corrected info');
                    showToast("å·²ç”Ÿæˆ");
                    displayCorrectInfo(correctInfo);
                    
                }else {
                    console.log('Fetching corrected image from API');
                    fetchCorrectedImage(imageFile); // Ensure the fetch call happens
                }
            } else {
                console.log('Image file has changed, fetching new corrected image');
                fetchCorrectedImage(currentImageFile);
            }
            // document.getElementById('infoContainer').style.display = 'block';
        } else {
            console.log('Switch is off');
            clearCanvas();
            document.getElementById('infoContainer').style.display = 'none';
        }
    });

    // æ˜¾ç¤ºçº æ­£ä¿¡æ¯
    // function displayCorrectInfo(correctInfo) {
    //     const infoContainer = document.getElementById("infoContainer");
    //     infoContainer.innerHTML = '';
    //     correctInfo.forEach(item => {
    //         const infoItem = document.createElement("div");
    //         infoItem.className = "info-item";
    //         infoItem.innerHTML = `${item.correct_id}. "${item.img_mark_type}", "${item.modified_result}"`;
    //         infoContainer.appendChild(infoItem);
    //     });
    // }
    function displayCorrectInfo(correctInfo) {
    const infoContainer = document.getElementById("infoContainer");
    infoContainer.innerHTML = '';
    
    correctInfo.forEach(item => {
        const infoItem = document.createElement("div");
        infoItem.className = "info-item";
        infoItem.dataset.id = item.correct_id;// ä¿®æ”¹1
        
        // æ ¹æ®ä¸åŒç±»å‹ç”Ÿæˆäººæ€§åŒ–æè¿°
        let description = '';
        
        
        switch(item.img_mark_type) {
            case 'delete':
                description = `delete`;
                break;
            case 'edit':
                description = `edit to"${item.modified_result}"`;
                break;
            case 'add':
                description = `add"${item.modified_result}"`;
                break;
            case 'word-order':
                description = `wrong word order`;
                break;
            default:
                description = `è¿›è¡Œäº†æœªçŸ¥æ“ä½œ`;
        }
        
        infoItem.innerHTML = `
            <div class="correction-id">Edit ${item.correct_id+1}:</div>
            <div class="correction-desc">${description}</div>
        `;
        infoContainer.appendChild(infoItem);
    });
}


// ä¸­æ–‡ç‰ˆ
function displayCorrectInfoInCh(correctInfo) {
    const infoContainer = document.getElementById("infoContainer");
    infoContainer.innerHTML = '';
    
    correctInfo.forEach(item => {
        const infoItem = document.createElement("div");
        infoItem.className = "info-item";
        infoItem.dataset.id = item.correct_id;// ä¿®æ”¹1
        
        // æ ¹æ®ä¸åŒç±»å‹ç”Ÿæˆäººæ€§åŒ–æè¿°
        let description = '';
        
        
        switch(item.img_mark_type) {
            case 'delete':
                description = `åˆ é™¤`;
                break;
            case 'edit':
                description = `ä¿®æ”¹ä¸º"${item.modified_result}"`;
                break;
            case 'add':
                description = `æ·»åŠ "${item.modified_result}"`;
                break;
            case 'word-order':
                description = `è¯­åºé”™è¯¯`;
                break;
            default:
                description = `è¿›è¡Œäº†æœªçŸ¥æ“ä½œ`;
        }
        
        infoItem.innerHTML = `
            <div class="correction-id">ç¬¬${item.correct_id+1}å¤„ä¿®æ”¹:</div>
            <div class="correction-desc">${description}</div>
        `;
        infoContainer.appendChild(infoItem);
    });
}
// ä¿®æ”¹1


// é«˜äº®
    let regions = [];
    
    function handleMouseMove(e) {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    console.log("mousemove working!",mouseX,mouseY);
    regions.forEach(region => {
        if (
            mouseX >= region.x1 && mouseX <= region.x2 &&
            mouseY >= region.y1 && mouseY <= region.y2
        ) {
            console.log("Hovering region:", region);
            hoveredId = region.correct_id;
        }
    });

    document.querySelectorAll(".info-item").forEach(el => {
        if (parseInt(el.dataset.id) === hoveredId) {
            el.classList.add("highlight");
        } else {
            el.classList.remove("highlight");
        }
    });
}

// ä¸­è‹±åˆ‡æ›
    const enBtn = document.getElementById("en");
    const zhBtn = document.getElementById("zh");
    

    enBtn.addEventListener("click", () => {
      enBtn.classList.add("active");
      zhBtn.classList.remove("active");
      uploadBtn.textContent = "Click to upload a file";
      template1.textContent = "template 1";
      template2.textContent = "template 2";
      template3.textContent = "template 3";
      template4.textContent = "template 4";
      template5.textContent = "template 5";
      template6.textContent = "template 6";
      progress.textContent ="Edit progress";
      title.textContent ="Educational Writing Correction System";
      rotateBtn.textContent = "Rotate"
      cropBtn.textContent = "Crop"
      exportBtn.textContent = "Export"
      displayCorrectInfo(correctInfo)
    });

    zhBtn.addEventListener("click", () => {
      zhBtn.classList.add("active");
      enBtn.classList.remove("active");
      uploadBtn.textContent = "ç‚¹æŒ‰ä»¥ä¸Šä¼ æ–‡æ¡£";
      template1.textContent = "ä¾‹å­1";
      template2.textContent = "ä¾‹å­2";
      template3.textContent = "ä¾‹å­3";
      template4.textContent = "ä¾‹å­4";
      template5.textContent = "ä¾‹å­5";
      template6.textContent = "ä¾‹å­6";
      progress.textContent ="ç¼–è¾‘è¿›åº¦";
      title.textContent ="æ•™è‚²å†™ä½œçº é”™ç³»ç»Ÿ";
      rotateBtn.textContent = "æ—‹è½¬"
      cropBtn.textContent = "è£å‰ª"
      exportBtn.textContent = "å¯¼å‡º"
      displayCorrectInfoInCh(correctInfo)
      
    });
    // ä¸Šå‚³æª”æ¡ˆäº‹ä»¶
    
    let rotation = 0;

    rotateBtn.addEventListener("click", () => {
  rotateImage90();
});

function rotateImage90() {
  // ä¸´æ—¶ç”»å¸ƒ
  const tempCanvas = document.createElement("canvas");
  const tctx = tempCanvas.getContext("2d");

  // æ ¹æ®æ—‹è½¬åå®½é«˜è®¾ç½®ç”»å¸ƒ
  tempCanvas.width = img.height;
  tempCanvas.height = img.width;

  // è®¾ç½®æ—‹è½¬ä¸­å¿ƒå¹¶æ—‹è½¬
  tctx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
  tctx.rotate(90 * Math.PI / 180);
  tctx.drawImage(img, -img.width / 2, -img.height / 2);

  // æ›´æ–° imgï¼ˆæŠŠæ—‹è½¬åçš„ç»“æœå˜æˆæ–°çš„ imgï¼‰
  const rotatedImg = new Image();
  rotatedImg.onload = () => {
    img = rotatedImg; // æ›¿æ¢æˆæ–°çš„ img
    drawImageToMainCanvas();
    //
    const mainCanvas = document.getElementById('canvasOverlay');
        
        // ä»ç”»å¸ƒè·å– Blob å¯¹è±¡ï¼Œå†åˆ›å»º File
        mainCanvas.toBlob(blob => {
        const imageFile = new File([blob], "575.jpg", { type: blob.type});
        console.log("å¾—åˆ°æœ‰æ•ˆçš„ imageFile:", imageFile);
        currentImageFile = imageFile;
        const reader = new FileReader();
            console.log(reader);
            reader.onload = (event) => {
                const imgC = new Image();
                console.log("success");

                originalImageSrc = event.target.result;
                imgC.src = originalImageSrc;
                imgC.onload = (event) => {
                    img = imgC;
                }
            };
            reader.readAsDataURL(currentImageFile);
        }, croppedImg.type);

  };
  rotatedImg.src = tempCanvas.toDataURL();
}

function drawImageToMainCanvas() {
  // ç”»å¸ƒå¤§å°å’Œå›¾ç‰‡ä¸€è‡´
  canvas.width = calculate(img.width);
  canvas.height = calculate(img.height);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
}

    // è£å‰ª
    let startX, startY, endX, endY, isDragging = false;
    let displayScale = 1; // æ˜¾ç¤ºæ¯”ä¾‹ï¼ˆåŸå§‹å›¾åˆ°cropCanvasçš„ç¼©æ”¾ï¼‰
    const cropOverlay = document.getElementById("cropOverlay");
    const cropCanvas = document.getElementById("cropCanvas");
    const cropCtx = cropCanvas.getContext("2d");
    const cropDoneBtn = document.getElementById("cropDoneBtn");

    cropBtn.addEventListener("click", () => {
      
      if (!img.src) return;
      cropOverlay.style.display = "flex";

      // å¼¹çª—é‡Œç­‰æ¯”ç¼©æ”¾é€‚åº”é«˜åº¦
      displayScale = (window.innerHeight * 0.8) / img.height;
      cropCanvas.width = img.width * displayScale;
      cropCanvas.height = img.height * displayScale;
      cropCtx.drawImage(img, 0, 0, cropCanvas.width, cropCanvas.height);

      // æ‹–æ‹½ç»˜åˆ¶çŸ©å½¢
      cropCanvas.onmousedown = e => {
        isDragging = true;
        startX = e.offsetX;
        startY = e.offsetY;
      };

      cropCanvas.onmousemove = e => {
  if (!isDragging) return;
  endX = e.offsetX;
  endY = e.offsetY;

  // 1. å…ˆç”»æ•´å¼ å›¾
  cropCtx.drawImage(img, 0, 0, cropCanvas.width, cropCanvas.height);

  // 2. å†ç”»é®ç½©
  cropCtx.fillStyle = "rgba(0,0,0,0.5)";
  cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);

  // 3. é€‰åŒº
  let x = Math.min(startX, endX);
  let y = Math.min(startY, endY);
  let w = Math.abs(endX - startX);
  let h = Math.abs(endY - startY);

  // æŠŠé€‰åŒºéƒ¨åˆ†å†ç”»ä¸€éåŸå›¾
  cropCtx.drawImage(
    img,
    x / displayScale, y / displayScale, w / displayScale, h / displayScale, // åŸå›¾åŒºåŸŸ
    x, y, w, h // åœ¨ cropCanvas ä¸Šçš„åŒºåŸŸ
  );

  // ç”»è¾¹æ¡†
  cropCtx.strokeStyle = "red";
  cropCtx.lineWidth = 2;
  cropCtx.strokeRect(x, y, w, h);
};

      cropCanvas.onmouseup = e => {
        isDragging = false;
        endX = e.offsetX;
        endY = e.offsetY;
      };
    });

    // è£å‰ªå®Œæˆ
    cropDoneBtn.addEventListener("click", () => {
      let x = Math.min(startX, endX) / displayScale;
      let y = Math.min(startY, endY) / displayScale;
      let w = Math.abs(endX - startX) / displayScale;
      let h = Math.abs(endY - startY) / displayScale;

      // ä»åŸå§‹å›¾åƒè£å‰ªï¼Œé¿å…æ¨¡ç³Š
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = w;
      tempCanvas.height = h;
      const tctx = tempCanvas.getContext("2d");
      tctx.drawImage(img, x, y, w, h, 0, 0, w, h);

      const croppedImg = new Image();
      croppedImg.onload = () => {
        img = croppedImg;
        rotation = 0;
        drawImageToMainCanvas();
        console.log("å¾—åˆ°è£å‰ªåçš„imageFileï¼ˆæœªç»è¿‡è½¬æ¢ï¼‰:",img.width,img.height);
        // const imageFile = new File([croppedImg], "575.jpg", { type: croppedImg.type });
        // console.log("å¾—åˆ° imageFile:", imageFile);
        // currentImageFile = imageFile;
        // å‡è®¾ mainCanvas æ˜¯ç»˜åˆ¶äº†è£å‰ªåå›¾åƒçš„ç”»å¸ƒ
        const mainCanvas = document.getElementById('canvasOverlay');
        
        // ä»ç”»å¸ƒè·å– Blob å¯¹è±¡ï¼Œå†åˆ›å»º File
        mainCanvas.toBlob(blob => {
        const imageFile = new File([blob], "575.jpg", { type: blob.type});
        console.log("å¾—åˆ°æœ‰æ•ˆçš„ imageFile:", imageFile);
        currentImageFile = imageFile;
        const reader = new FileReader();
            console.log(reader);
            reader.onload = (event) => {
                const imgC = new Image();
                console.log("success");

                originalImageSrc = event.target.result;
                imgC.src = originalImageSrc;
                imgC.onload = (event) => {
                    img = imgC;
                }
            };
            reader.readAsDataURL(currentImageFile);
        }, croppedImg.type);

        
      };
      croppedImg.src = tempCanvas.toDataURL();

      cropOverlay.style.display = "none";
    });

    // å¯¼å‡º
    exportBtn.addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "edited.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    // let correctInfo = null;
    // let currentImageFile = null; // å½“å‰å¤„ç†çš„å›¾ç‰‡æ–‡ä»¶
    // // å‘é€æŒ‰é’®ç‚¹å‡»æ—¶åŠ è½½åŸå§‹å›¾ç‰‡å¹¶æ˜¾ç¤º
    // document.getElementById('sendMessage').addEventListener('click', () => {
    //     const imageFile = document.getElementById('uploadImage').files[0];
    //
    //     if (imageFile) {
    //         // æ¸…ç©ºä¹‹å‰çš„çº æ­£åçš„å›¾ç‰‡å’Œä¿¡æ¯å†…å®¹
    //         document.getElementById('imageContainer').innerHTML = ''; // æ¸…ç©ºçº æ­£åçš„å›¾ç‰‡
    //         const infoContainer = document.getElementById('infoContainer');
    //         infoContainer.innerHTML = ''; // æ¸…ç©ºä¿¡æ¯å†…å®¹
    //         infoContainer.style.display = 'none'; // éšè— info-container
    //
    //         // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
    //         const reader = new FileReader();
    //         reader.onload = (event) => {
    //             originalImage = event.target.result;
    //             document.getElementById('imageContainer').innerHTML = `<img src="${originalImage}" class="corrected-image">`;
    //         };
    //         reader.readAsDataURL(imageFile);
    //
    //         // æ›´æ–°å½“å‰å›¾ç‰‡æ–‡ä»¶
    //         currentImageFile = imageFile;
    //
    //         // é‡ç½®å¼€å…³çŠ¶æ€ä¸º off
    //         document.getElementById('myonoffswitch').checked = false;
    //
    //         // é‡ç½®çŠ¶æ€
    //         correctedImage = null; // æ¸…ç©ºçº æ­£åçš„å›¾ç‰‡
    //         correctInfo = null; // æ¸…ç©ºçº æ­£åçš„ä¿¡æ¯
    //         isCorrectedFetched = false; // é‡ç½®å·²è·å–çŠ¶æ€
    //     }
    // });


    // // ç›‘å¬å¼€å…³çŠ¶æ€å˜åŒ–
    // document.getElementById('myonoffswitch').addEventListener('change', (event) => {
    //     if (event.target.checked) {
    //         // Switch is turned ON
    //         if (currentImageFile === document.getElementById('uploadImage').files[0]) {
    //             // å½“å‰å›¾ç‰‡ä¸ä¸Šæ¬¡å¤„ç†çš„å›¾ç‰‡ç›¸åŒ
    //             if (isCorrectedFetched && correctedImage) {
    //                 // å·²ç»è·å–è¿‡çº æ­£åçš„å›¾ç‰‡ï¼Œç›´æ¥æ˜¾ç¤º
    //                 document.getElementById('imageContainer').innerHTML = `<img src="${correctedImage}" class="corrected-image">`;
    //                 displayCorrectInfo(correctInfo); // æ˜¾ç¤ºä¿¡æ¯
    //             } else {
    //                 // æœªè·å–è¿‡çº æ­£åçš„å›¾ç‰‡ï¼Œè°ƒç”¨API
    //                 fetchCorrectedImage(currentImageFile);
    //             }
    //         } else {
    //             // å½“å‰å›¾ç‰‡ä¸ä¸Šæ¬¡å¤„ç†çš„å›¾ç‰‡ä¸åŒï¼Œéœ€è¦é‡æ–°å¤„ç†
    //             fetchCorrectedImage(currentImageFile);
    //         }
    //     } else {
    //         // Switch is turned OFF, æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
    //         if (originalImage) {
    //             document.getElementById('imageContainer').innerHTML = `<img src="${originalImage}" class="corrected-image">`;
    //         }
    //         document.getElementById('infoContainer').style.display = 'none'; // éšè— info-container
    //     }
    // });
    //
    // function fetchCorrectedImage(imageFile) {
    //     if (imageFile) {
    //         const formData = new FormData();
    //         formData.append('image', imageFile);
    //
    //         const api = 'http://49.52.27.15:5000/img_correct';
    //
    //         // æ¸…ç©ºä¸Šä¸€ä¸ªçº æ­£åçš„å›¾ç‰‡å’Œä¿¡æ¯
    //         correctedImage = null;
    //         correctInfo = null;
    //
    //         fetch(api, {
    //             method: 'POST',
    //             body: formData,
    //         })
    //             .then(response => response.json())
    //             .then(data => {
    //                 console.log(data);
    //                 correctInfo = data.correct_info;

    //                 // correctedImage = `http://49.52.27.15:5000/temp_images/temp_corrected_image.png`; // æ„å»ºå®Œæ•´ URL
    //                 // isCorrectedFetched = true;
    //                 //
    //                 // // æ˜¾ç¤ºçº æ­£åçš„å›¾ç‰‡
    //                 // document.getElementById('imageContainer').innerHTML = `<img src="${correctedImage}" class="corrected-image">`;
    //                 // displayCorrectInfo(data.correct_info); // æ˜¾ç¤ºä¿¡æ¯
    //             })
    //             .catch(error => {
    //                 console.error('Error:', error);
    //                 alert('å›¾åƒçº é”™æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
    //                 // Turn off the switch if there is an error
    //                 document.getElementById('myonoffswitch').checked = false;
    //             });
    //     }
    // }
    // function displayCorrectInfo(correctInfo) {
    //     const infoContainer = document.getElementById("infoContainer");
    //     infoContainer.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
    //     infoContainer.style.display = 'block'; // æ˜¾ç¤º info-container
    //
    //     // éå† correct_info å¹¶ç”Ÿæˆ HTML å†…å®¹
    //     correctInfo.forEach(item => {
    //         const infoItem = document.createElement("div");
    //         infoItem.className = "info-item";
    //         infoItem.innerHTML = `${item.correct_id}. "${item.img_mark_type}", "${item.modify_result}"`;
    //         infoContainer.appendChild(infoItem);
    //     });
    // }
 // ****************ä»¥ä¸‹ä¸ºæµ‹è¯•
//  window.onload = function () {
        
//         //  document.getElementById('imageContainer').innerHTML = `<img src="${originalImageSrc}"  id="originalImage" class="corrected-image">`;
//         // *****************************ls
        
//         const img = new Image();
//         img.src =  originalImageSrc;

//         img.onload = function() {
//           // è®¾ç½® canvas çš„å®½é«˜å’Œå›¾ç‰‡ä¸€è‡´
//           canvas.width = img.width;
//           canvas.height = img.height;

//          // å°†å›¾ç‰‡ç»˜åˆ¶åˆ° canvas ä¸Š
//           ctx.drawImage(img, 0, 0);
          
//         };
//  };
        // **************************/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQ
</script>
</body>
</html>