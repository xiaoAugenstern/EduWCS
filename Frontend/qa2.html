<!DOCTYPE html>
<html>
<head>
    <!-- 添加 viewport meta 标签 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="utf-8">
    <title>Educational Writing Correction System</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container-wrapper">
        <!-- 左侧对话框容器 -->
        <div class="chat-container" id="chatContainer2">
            <div class="chat-title-left">
                <span class="visualization-text" id = "title">Educational Writing Correction System</span>
                
                <button class = "editImg" id = "rotateBtn" >Rotate</button>
                <button class = "editImg" id = "cropBtn" >Crop</button>
                <button class = "editImg" id = "exportBtn" >Export</button>

                <div class="onoffswitch">
                    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch">
                    <label class="onoffswitch-label" for="myonoffswitch">
                        <span class="onoffswitch-inner"></span>
                        <span class="onoffswitch-switch"></span>
                    </label>
                    
                </div>
            </div>
            <div class="image-container" id="imageContainer">
                <!-- 原始图像 -->
             
                <!-- 用于绘制线条的 Canvas -->
                <canvas id="canvasOverlay" class="overlay-canvas" ></canvas>
            </div>
        </div>
    </div>
    <div>
        <div class="input-box">
            <div class="lang-switch">
                <span class="icon">🌐</span>
                <span id="en" class="lang-option active">English</span>
                <span id="zh" class="lang-option">简中</span>
              </div>
            <input type="file" id="uploadImage" accept="image/*">
            <button class="upload-btn" id="uploadBtn">Click to upload a file</button>
            <span id ="fileName"></span>
            <!-- <button id="sendMessage">Send</button>
            <button id="enableDetection">开启检测</button> -->
            <div class="case-box">
                <button data-file="case1.png" class="case" id = "template1">template 1</button>
                <button data-file="case2.jpg" class="case" id = "template2">template 2</button>
                <button data-file="case3.png" class="case" id = "template3">template 3</button>
                <button data-file="case4.jpg" class="case" id = "template4">template 4</button>
                <button data-file="case5.jpg" class="case" id = "template5">template 5</button>
                <button data-file="case6.jpg" class="case" id = "template6">template 6</button>
            </div>
            <div class="progress-control">
                <input type="range" id="editProgress" min="0" max="100" value="0" class="progress-slider">
                <div class="progress-text">
                    <span id="progress">Edit progress: </span>
                    <span id="progressValue">0%</span>
                </div>
            </div>
        <!-- 用于显示 correct_info 信息的容器 -->
        <div id="infoContainer" class="info-container"></div>
    </div>

  <!-- 裁剪弹窗 -->
  <div id="cropOverlay">
    <canvas id="cropCanvas"></canvas>
    <button id="cropDoneBtn">裁剪完成</button>
  </div>

<!-- 处理 -->
<div id="toast">
    <div id="spinner"></div>
    <span id="toastText"></span>
  </div>

</div>

<script>
    

    function calculate(original) {
    
    const originalWidth = img.width;
    return 890/img.width*original;
    };
    

    document.querySelector('.onoffswitch-checkbox').addEventListener('change', function(e) {
        if (this.checked) {
            console.log('Switch is ON');
        } else {
            console.log('Switch is OFF');
        }
    });

    let correctInfo = null; // 纠正信息 
    let currentImageFile = null; // 当前处理的图片文件
    let originalImageSrc = null; // 原始图片的 DataURL
    let correctedImage = null; // 纠正后的图片
    let isCorrectedFetched = false; // 是否已获取纠正后的图像

    let correctInfoTemp = [   // 测试1
    {
        "correct_id": 0,
        "fk_error_id": null,
        "img_box": [
            {
                "method1": {
                    "delete_line": {
                        "end_x": 292,
                        "end_y": 302,
                        "start_x": 268,
                        "start_y": 302
                    }
                },
                "method2": {
                    "delete_box": {
                        "end_x": 292,
                        "end_y": 315,
                        "start_x": 268,
                        "start_y": 289
                    }
                }
            }
        ],
        "img_mark_type": "delete",
        "modified_result": "-NONE-"
    },
    {
        "correct_id": 1,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 371,
                "end_y": 314,
                "start_x": 347,
                "start_y": 288
            }
        ],
        "img_mark_type": "edit",
        "modified_result": "假期"
    },
    {
        "correct_id": 2,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 522,
                "end_y": 279,
                "start_x": 522,
                "start_y": 252
            }
        ],
        "img_mark_type": "add",
        "modified_result": "时候"
    },
    {
        "correct_id": 3,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 369,
                "end_y": 388,
                "start_x": 369,
                "start_y": 360
            }
        ],
        "img_mark_type": "add",
        "modified_result": "，"
    },
    {
        "correct_id": 4,
        "fk_error_id": null,
        "img_box": [
            {
                "method1": {
                    "delete_line": {
                        "end_x": 584,
                        "end_y": 662,
                        "start_x": 538,
                        "start_y": 662
                    }
                },
                "method2": {
                    "delete_box": {
                        "end_x": 584,
                        "end_y": 675,
                        "start_x": 538,
                        "start_y": 650
                    }
                }
            }
        ],
        "img_mark_type": "delete",
        "modified_result": "-NONE-"
    },
    {
        "correct_id": 5,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 120,
                "end_y": 62,
                "start_x": 120,
                "start_y": 38
            }
        ],
        "img_mark_type": "add",
        "modified_result": "，"
    },
    {
        "correct_id": 6,
        "fk_error_id": null,
        "img_box": [
            {
                "method1": {
                    "delete_line": {
                        "end_x": 211,
                        "end_y": 158,
                        "start_x": 136,
                        "start_y": 158
                    }
                },
                "method2": {
                    "delete_box": {
                        "end_x": 211,
                        "end_y": 169,
                        "start_x": 136,
                        "start_y": 147
                    }
                }
            }
        ],
        "img_mark_type": "delete",
        "modified_result": "-NONE-"
    },
    {
        "correct_id": 7,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 313,
                "end_y": 494,
                "start_x": 284,
                "start_y": 468
            }
        ],
        "img_mark_type": "edit",
        "modified_result": "广场"
    },
    {
        "correct_id": 8,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 266,
                "end_y": 566,
                "start_x": 244,
                "start_y": 541
            }
        ],
        "img_mark_type": "edit",
        "modified_result": "凋"
    },
    {
        "correct_id": 9,
        "fk_error_id": null,
        "img_box": [
            {
                "end_x": 506,
                "end_y": 638,
                "start_x": 485,
                "start_y": 614
            }
        ],
        "img_mark_type": "edit",
        "modified_result": "休"
    },
    {
        "correct_id": 10,
        "fk_error_id": null,
        "img_box": [
            {
                "method1": {
                    "delete_line": {
                        "end_x": 371,
                        "end_y": 409,
                        "start_x": 311,
                        "start_y": 409
                    }
                },
                "method2": {
                    "delete_box": {
                        "end_x": 371,
                        "end_y": 422,
                        "start_x": 311,
                        "start_y": 397
                    }
                }
            }
        ],
        "img_mark_type": "delete",
        "modified_result": "-NONE-"
    }
]
    

    // 更新 Canvas 尺寸以适应图像大小
    function updateCanvasSize(imageElement) {
        if (canvas) {
            canvas.width = imageElement.clientWidth;
            canvas.height = imageElement.clientHeight;
            console.log('Canvas width:', canvas.width, 'Canvas height:', canvas.height);
        } else {
            console.error('Canvas element not found!');
        }
    }
    // 清空 Canvas 绘制内容
    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    const progressSlider = document.getElementById('editProgress');
    const progressValue = document.getElementById('progressValue'); 
    // function frawlines(correctInfo)
    let canvas = document.getElementById('canvasOverlay');
    let ctx = canvas.getContext('2d');
    
    // 画线
    function drawLines(correctInfo) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
            // 设置 canvas 的宽高和图片一致
             canvas.width = calculate(img.width);
             canvas.height = calculate(img.height);

             // 将图片绘制到 canvas 上
             ctx.drawImage(img, 0, 0,canvas.width,canvas.height);
                 
                
        //*********************************ls
        const progress = parseInt(progressSlider.value);
        const showCount = Math.ceil(correctInfo.length * progress / 100);
        console.log('Drawing test shape...');
        // ctx.strokeStyle = 'blue';
        // ctx.lineWidth = 5;
        // ctx.beginPath();
        // ctx.moveTo(0, 0);
        // ctx.lineTo(100, 100);
        // ctx.stroke(); // 绘制一条线进行测试
        // console.log('Canvas width:', canvas.width, 'Canvas height:', canvas.height);
        // console.log('Canvas ctx',ctx)
        // console.log('correctInfo:', correctInfo); // 调试输出
        // ctx.fillStyle = 'red';
        // ctx.fillRect(10, 10, 50, 50); // 在 Canvas 上绘制一个红色方块
        // correctInfoTest = [{'correct_id': 0, 'img_box': [{'start_x': 361, 'start_y': 289, 'end_x': 361, 'end_y': 314}], 'modified_result': '假期', 'img_mark_type': 'add', 'fk_error_id': None}, {'correct_id': 1, 'img_box': [{'start_x': 522, 'start_y': 252, 'end_x': 522, 'end_y': 279}], 'modified_result': '时间', 'img_mark_type': 'add', 'fk_error_id': None}, {'correct_id': 2, 'img_box': [{'start_x': 369, 'start_y': 360, 'end_x': 369, 'end_y': 388}], 'modified_result': '，', 'img_mark_type': 'add', 'fk_error_id': None}, {'correct_id': 3, 'img_box': [{'method1': {'delete_line': {'start_x': 136, 'start_y': 158, 'end_x': 211, 'end_y': 158}}, 'method2': {'delete_box': {'start_x': 136, 'start_y': 147, 'end_x': 211, 'end_y': 169}}}], 'modified_result': '-NONE-', 'img_mark_type': 'delete', 'fk_error_id': None}, {'correct_id': 4, 'img_box': [{'start_x': 284, 'start_y': 468, 'end_x': 313, 'end_y': 494}], 'modified_result': '池塘', 'img_mark_type': 'edit', 'fk_error_id': None}, {'correct_id': 5, 'img_box': [{'start_x': 244, 'start_y': 541, 'end_x': 266, 'end_y': 566}], 'modified_result': '凋', 'img_mark_type': 'edit', 'fk_error_id': None}, {'correct_id': 6, 'img_box': [{'start_x': 485, 'start_y': 614, 'end_x': 506, 'end_y': 638}], 'modified_result': '休', 'img_mark_type': 'edit', 'fk_error_id': None}, {'correct_id': 7, 'img_box': [{'method1': {'delete_line': {'start_x': 311, 'start_y': 409, 'end_x': 371, 'end_y': 409}}, 'method2': {'delete_box': {'start_x': 311, 'start_y': 397, 'end_x': 371, 'end_y': 422}}}], 'modified_result': '-NONE-', 'img_mark_type': 'delete', 'fk_error_id': None}];
        for (let i = 0; i < showCount; i++) {
        const item = correctInfo[i];
       
            const { img_mark_type, img_box, modified_result } = item;
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.fillStyle = 'red';
            ctx.font = '16px Arial';
            console.log('Drawing test shape...');

            if (img_mark_type === 'add') {
    // 处理“添加”标记
            if (Array.isArray(img_box) && img_box.length === 1) {
            let { start_x, start_y, end_x, end_y } = img_box[0];

               start_x = calculate(start_x);
               start_y = calculate(start_y);
               end_x = calculate(end_x);
               end_y = calculate(end_y);
               ctx.beginPath();
               ctx.moveTo(start_x, start_y);
               ctx.lineTo(end_x, end_y);
               ctx.strokeStyle = 'red';  // 可以用绿色表示“添加”
               ctx.stroke();

               ctx.font = "16px Arial";
               ctx.fillStyle = "red";
               ctx.fillText(modified_result, start_x, start_y - 10);
    } else {
        console.error('Invalid img_box structure for add mark:', img_box);
    }
}


    else if (img_mark_type === 'delete') {
    if (Array.isArray(img_box)) {
        img_box.forEach(box => {
            if (
                typeof box === 'object' &&
                box !== null &&
                box.method1 &&
                box.method1.delete_line
            ) {
                let { start_x, start_y, end_x, end_y } = box.method1.delete_line;
                start_x = calculate(start_x);
                start_y = calculate(start_y);
                end_x = calculate(end_x);
                end_y = calculate(end_y);
                ctx.beginPath();
                ctx.moveTo(start_x, start_y);
                ctx.lineTo(end_x, end_y);
                ctx.strokeStyle = 'red'; // 可选：设置删除线颜色
                ctx.stroke();
            } 
            else {
                console.error('Invalid box structure for delete mark:', box);
            }
            if (
                typeof box === 'object' &&
                box !== null &&
                box.method2 &&
                box.method2.delete_box
            ) {
                let { start_x, start_y, end_x, end_y } = box.method2.delete_box;
                start_x = calculate(start_x);
                start_y = calculate(start_y);
                end_x = calculate(end_x);
                end_y = calculate(end_y);
                ctx.strokeStyle = 'red';
                ctx.strokeRect(start_x, start_y, end_x - start_x, end_y - start_y);

                // 可选：在框下方写文字说明
                ctx.font = "14px Arial";
                ctx.fillStyle = "red";
               
            }
        });
                } else {
                    console.error('Invalid img_box structure for delete mark:', img_box);
                }
            } 


            else if (img_mark_type === 'edit') {
                if (Array.isArray(img_box)) {
                    
                    img_box.forEach((box, index) => {
                        // console.log('Processing edit mark with box:', box);
                        let { start_x, start_y, end_x, end_y } = box; // 使用解构赋值来获取对象属性
                        start_x = calculate(start_x);
                        start_y = calculate(start_y);
                        end_x = calculate(end_x);
                        end_y = calculate(end_y);
                        ctx.strokeRect(start_x, start_y, end_x - start_x, end_y - start_y);
                        ctx.fillText(modified_result, start_x +(end_x - start_x), end_y+15);
                        console.log(modified_result);
                    });
                } else {
                    console.error('Invalid img_box structure for edit mark:', img_box);
                }
            } else if (img_mark_type === 'word-order') {
                // 处理“字序”标记
                if (Array.isArray(img_box)) {
                    const method1 = img_box[0].method1;
                    let { bottom, right, top } = method1;
                    bottom = calculate(bottom);
                    right= calculate(right);
                    top = calculate(top);

                    // console.log('Line details for word-order mark:', { bottom, right, top });
                    ctx.beginPath();
                    // 绘制顶部线
                    ctx.moveTo(top.x1, top.y1);
                    ctx.lineTo(top.x2, top.y2);
                    // 绘制右侧线
                    ctx.moveTo(right.x1, right.y1);
                    ctx.lineTo(right.x2, right.y2);
                    // 绘制底部线
                    ctx.moveTo(bottom.x1, bottom.y1);
                    ctx.lineTo(bottom.x2, bottom.y2);
                    ctx.stroke();}
                else {
                    console.error('Invalid img_box structure for word-order mark:', img_box);
                }
            } else {
                console.error('Unknown img_mark_type:', img_mark_type);
            }
          }
};
    progressValue.textContent = '0%';
    progressSlider.addEventListener('input', function() {
    progressValue.textContent = this.value + '%';
    drawLines(correctInfo);
   
});

    let img = new Image();
    let currentImg = new Image();

    // 上传
    document.getElementById('uploadBtn').addEventListener('click', () => { // 
        uploadImage.click();
        
    });

    uploadImage.addEventListener("change", () => {
      if (uploadImage.files.length > 0) {
        fileName.textContent = uploadImage.files[0].name;
      } else {
        // 判斷目前語言
        if (enBtn.classList.contains("active")) {
          fileName.textContent = texts.en.nofile;
        } else {
          fileName.textContent = texts.zh.nofile;
        }
      }

      const imageFile = document.getElementById('uploadImage').files[0];
        if (imageFile) {
            // 清空之前的内容
            // document.getElementById('imageContainer').innerHTML = '';

            // const infoContainer = document.getElementById('infoContainer');
            // infoContainer.innerHTML = '';
            // infoContainer.style.display = 'none';

            // 显示原始图片
            const reader = new FileReader();
            console.log(reader);
            reader.onload = (event) => {
                originalImageSrc = event.target.result;
                //  document.getElementById('imageContainer').innerHTML = `<img src="${originalImageSrc}"  id="originalImage" class="corrected-image">`;
                
                // *****************************ls
                const canvas = document.getElementById('canvasOverlay');
                const ctx = canvas.getContext('2d');
                img.src =  originalImageSrc;
                
                img.onload = function() {
                  // 设置 canvas 的宽高和图片一致
                  canvas.width = calculate(img.width);
                  canvas.height = calculate(img.height);
                  console.log(img.width);
                 // 将图片绘制到 canvas 上
                  ctx.drawImage(img, 0, 0,canvas.width,canvas.height);
                  currentImg = img;
                };
            };

            reader.onerror = (error) => {
                alert('图片读取失败，请重试！');
                console.error('File reading error:', error);
            };

            reader.readAsDataURL(imageFile);

            // 更新当前图片文件
            currentImageFile = imageFile;

            // 重置开关状态
            document.getElementById('myonoffswitch').checked = false;
            clearCanvas();
            correctedImage = null;
            correctInfo = null;
            isCorrectedFetched = false;
        }
    });


    // caseSolution
    document.querySelectorAll('.case').forEach(button => {
        
        button.addEventListener('click', async () => {
        const fileName = button.dataset.file;  // 获取 data-file
        if (!fileName) {
            console.error("按钮没有指定文件名！");
            return;
        }
    try {
        // 请求后端图片
        const response = await fetch(`http://127.0.0.1:5000/get_image/${fileName}`, {
            method: "GET"
    });
        const blob = await response.blob();

        // 转成 File 对象
        const imageFile = new File([blob], "575.jpg", { type: blob.type });
        console.log("得到 imageFile:", imageFile);

        if (imageFile) {
            // 清空之前的内容
            // document.getElementById('imageContainer').innerHTML = '';

            // const infoContainer = document.getElementById('infoContainer');
            // infoContainer.innerHTML = '';
            // infoContainer.style.display = 'none';

            // 显示原始图片
            const reader = new FileReader();
            console.log(reader);
            reader.onload = (event) => {
                originalImageSrc = event.target.result;
                //  document.getElementById('imageContainer').innerHTML = `<img src="${originalImageSrc}"  id="originalImage" class="corrected-image">`;
                // *****************************ls
                const canvas = document.getElementById('canvasOverlay');
                const ctx = canvas.getContext('2d');

                img.src =  originalImageSrc;
                img.onload = function() {
                  // 设置 canvas 的宽高和图片一致
                  console.log("得到 imageFile:",img.width,img.height,imageFile);
                  canvas.width = calculate(img.width);
                  canvas.height = calculate(img.height);
                  console.log(img.width);
                 // 将图片绘制到 canvas 上
                  ctx.drawImage(img, 0, 0,canvas.width,canvas.height);
                };
                //*********************************ls
            };

            reader.onerror = (error) => {
                alert('图片读取失败，请重试！');
                console.error('File reading error:', error);
            };

            reader.readAsDataURL(imageFile);

            // 更新当前图片文件
            currentImageFile = imageFile;

            // 重置开关状态
            document.getElementById('myonoffswitch').checked = false;
            clearCanvas();
            correctedImage = null;
            correctInfo = null;
            isCorrectedFetched = false;
        }
    } catch (err) {
        console.error("获取图片失败:", err);
        alert("获取图片失败！");
    }
    });
});



// 
const toast = document.getElementById('toast');
const spinner = document.getElementById('spinner');
const toastText = document.getElementById('toastText');

function showLoading() {
    toast.style.display = 'flex';
    toast.classList.add('show'); // 滑入动画
    spinner.style.display = 'inline-block';
    toastText.textContent = 'Processing...';
    toastText.style.color = '#333';
}

function showResult(text, color = 'green') {
    spinner.style.display = 'none';
    toastText.textContent = text;
    toastText.style.color = color;

    setTimeout(() => {
        toast.classList.remove('show'); // 开始滑出
        setTimeout(() => {
            toast.style.display = 'none';
            toastText.style.color = '#333'; // 重置颜色
        }, 300); // 等待滑出动画结束
    }, 1500); // 显示 1.5 秒后消失
}

    // 调用 API 获取纠正后的图像
    function fetchCorrectedImage(imageFile) {
        console.log('imageFile',imageFile);
        if (imageFile) {
            console.log('Fetching corrected image for:', imageFile);
            const formData = new FormData();
            formData.append('image', imageFile);
            const api = 'http://127.0.0.1:5000/img_correct';
            showLoading();
            // 测试1
            fetch(api, {
                method: 'POST',
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    correctInfo = data.correct_info;
                    isCorrectedFetched = true;
                    document.getElementById('infoContainer').style.display = 'block'; // 修改2
                    if (document.getElementById('myonoffswitch').checked) {
                        
                        console.log("hey");
                        console.log(correctInfo);
                        displayCorrectInfo(correctInfo);
                        progressSlider.value = 100;// 修改2
                        progressValue.textContent = '100%'; // 修改2
                        drawLines(correctInfo);
                        showResult('OK', 'green');

                        // 高亮
                        const canvas = document.getElementById("canvasOverlay");
    // 划定区域
        // 保存所有矩形区域

console.log("testing")
correctInfo.forEach(item => {
  item.img_box.forEach(box => {
    let coordsList = [];

     // 如果 box 里有 method1 或 method2，就取里面的值（排除 undefined）
    if (box.method2) {
      if (box.method2.delete_line) coordsList.push(box.method2.delete_line);
      if (box.method2.delete_box) coordsList.push(box.method2.delete_box);
    }

    // 如果是直接坐标对象
    if (box.start_x !== undefined) {
      coordsList.push(box);
    }

    // 统一存到 regions
    coordsList.forEach(coords => {
        
    let { start_x, start_y, end_x, end_y } = coords;
    start_x = calculate(start_x);
    start_y = calculate(start_y);
    end_x = calculate(end_x);
    end_y = calculate(end_y);
    if (start_x == end_x){
        start_x -= 10;
        end_x += 10;
    }
    regions.push({
        correct_id: item.correct_id,
        x1: Math.min(start_x, end_x),
        y1: Math.min(start_y, end_y),
        x2: Math.max(start_x, end_x),
        y2: Math.max(start_y, end_y)
      });
    });
    });
    });
    console.log(regions);



    canvas.addEventListener("mousemove", handleMouseMove);
    console.log("已开启鼠标检测");
    console.log(canvas.style.display, canvas.width, canvas.height);


                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('图像纠错时出现错误，请重试！');
                    document.getElementById('myonoffswitch').checked = false;
                    showResult('FAILURE', 'red');
                });

            // 测试1
            // correctInfo = correctInfoTemp
            // isCorrectedFetched = true;
            // document.getElementById('infoContainer').style.display = 'block';
            // displayCorrectInfo(correctInfo);
            // progressSlider.value = 100;
            // progressValue.textContent = '100%';
            // drawLines(correctInfo);
            // showResult('OK', 'green');

            
        }
    }

    // addded by charlie
    function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.display = 'block';
    
    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000); // 3秒后自动消失
} 

    // 开始纠错
    document.getElementById('myonoffswitch').addEventListener('change', (event) => {
        console.log('Switch changed:', event.target.checked);
        // Check if the current image file is selected
        const imageFile = currentImageFile
        if (!imageFile) {
            alert('请先上传图片！');
            return; // Exit if no image is selected
        }
        if (event.target.checked) {
            console.log('Switch is on');
            if (currentImageFile === document.getElementById('uploadImage').files[0]) {
                if (isCorrectedFetched && correctInfo) {
                    console.log('Using cached corrected info');
                    showToast("已生成");
                    displayCorrectInfo(correctInfo);
                    
                }else {
                    console.log('Fetching corrected image from API');
                    fetchCorrectedImage(imageFile); // Ensure the fetch call happens
                }
            } else {
                console.log('Image file has changed, fetching new corrected image');
                fetchCorrectedImage(currentImageFile);
            }
            // document.getElementById('infoContainer').style.display = 'block';
        } else {
            console.log('Switch is off');
            clearCanvas();
            document.getElementById('infoContainer').style.display = 'none';
        }
    });

    // 显示纠正信息
    // function displayCorrectInfo(correctInfo) {
    //     const infoContainer = document.getElementById("infoContainer");
    //     infoContainer.innerHTML = '';
    //     correctInfo.forEach(item => {
    //         const infoItem = document.createElement("div");
    //         infoItem.className = "info-item";
    //         infoItem.innerHTML = `${item.correct_id}. "${item.img_mark_type}", "${item.modified_result}"`;
    //         infoContainer.appendChild(infoItem);
    //     });
    // }
    function displayCorrectInfo(correctInfo) {
    const infoContainer = document.getElementById("infoContainer");
    infoContainer.innerHTML = '';
    
    correctInfo.forEach(item => {
        const infoItem = document.createElement("div");
        infoItem.className = "info-item";
        infoItem.dataset.id = item.correct_id;// 修改1
        
        // 根据不同类型生成人性化描述
        let description = '';
        
        
        switch(item.img_mark_type) {
            case 'delete':
                description = `delete`;
                break;
            case 'edit':
                description = `edit to"${item.modified_result}"`;
                break;
            case 'add':
                description = `add"${item.modified_result}"`;
                break;
            case 'word-order':
                description = `wrong word order`;
                break;
            default:
                description = `进行了未知操作`;
        }
        
        infoItem.innerHTML = `
            <div class="correction-id">Edit ${item.correct_id+1}:</div>
            <div class="correction-desc">${description}</div>
        `;
        infoContainer.appendChild(infoItem);
    });
}


// 中文版
function displayCorrectInfoInCh(correctInfo) {
    const infoContainer = document.getElementById("infoContainer");
    infoContainer.innerHTML = '';
    
    correctInfo.forEach(item => {
        const infoItem = document.createElement("div");
        infoItem.className = "info-item";
        infoItem.dataset.id = item.correct_id;// 修改1
        
        // 根据不同类型生成人性化描述
        let description = '';
        
        
        switch(item.img_mark_type) {
            case 'delete':
                description = `删除`;
                break;
            case 'edit':
                description = `修改为"${item.modified_result}"`;
                break;
            case 'add':
                description = `添加"${item.modified_result}"`;
                break;
            case 'word-order':
                description = `语序错误`;
                break;
            default:
                description = `进行了未知操作`;
        }
        
        infoItem.innerHTML = `
            <div class="correction-id">第${item.correct_id+1}处修改:</div>
            <div class="correction-desc">${description}</div>
        `;
        infoContainer.appendChild(infoItem);
    });
}
// 修改1


// 高亮
    let regions = [];
    
    function handleMouseMove(e) {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    console.log("mousemove working!",mouseX,mouseY);
    regions.forEach(region => {
        if (
            mouseX >= region.x1 && mouseX <= region.x2 &&
            mouseY >= region.y1 && mouseY <= region.y2
        ) {
            console.log("Hovering region:", region);
            hoveredId = region.correct_id;
        }
    });

    document.querySelectorAll(".info-item").forEach(el => {
        if (parseInt(el.dataset.id) === hoveredId) {
            el.classList.add("highlight");
        } else {
            el.classList.remove("highlight");
        }
    });
}

// 中英切換
    const enBtn = document.getElementById("en");
    const zhBtn = document.getElementById("zh");
    

    enBtn.addEventListener("click", () => {
      enBtn.classList.add("active");
      zhBtn.classList.remove("active");
      uploadBtn.textContent = "Click to upload a file";
      template1.textContent = "template 1";
      template2.textContent = "template 2";
      template3.textContent = "template 3";
      template4.textContent = "template 4";
      template5.textContent = "template 5";
      template6.textContent = "template 6";
      progress.textContent ="Edit progress";
      title.textContent ="Educational Writing Correction System";
      rotateBtn.textContent = "Rotate"
      cropBtn.textContent = "Crop"
      exportBtn.textContent = "Export"
      displayCorrectInfo(correctInfo)
    });

    zhBtn.addEventListener("click", () => {
      zhBtn.classList.add("active");
      enBtn.classList.remove("active");
      uploadBtn.textContent = "点按以上传文档";
      template1.textContent = "例子1";
      template2.textContent = "例子2";
      template3.textContent = "例子3";
      template4.textContent = "例子4";
      template5.textContent = "例子5";
      template6.textContent = "例子6";
      progress.textContent ="编辑进度";
      title.textContent ="教育写作纠错系统";
      rotateBtn.textContent = "旋转"
      cropBtn.textContent = "裁剪"
      exportBtn.textContent = "导出"
      displayCorrectInfoInCh(correctInfo)
      
    });
    // 上傳檔案事件
    
    let rotation = 0;

    rotateBtn.addEventListener("click", () => {
  rotateImage90();
});

function rotateImage90() {
  // 临时画布
  const tempCanvas = document.createElement("canvas");
  const tctx = tempCanvas.getContext("2d");

  // 根据旋转后宽高设置画布
  tempCanvas.width = img.height;
  tempCanvas.height = img.width;

  // 设置旋转中心并旋转
  tctx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
  tctx.rotate(90 * Math.PI / 180);
  tctx.drawImage(img, -img.width / 2, -img.height / 2);

  // 更新 img（把旋转后的结果变成新的 img）
  const rotatedImg = new Image();
  rotatedImg.onload = () => {
    img = rotatedImg; // 替换成新的 img
    drawImageToMainCanvas();
    //
    const mainCanvas = document.getElementById('canvasOverlay');
        
        // 从画布获取 Blob 对象，再创建 File
        mainCanvas.toBlob(blob => {
        const imageFile = new File([blob], "575.jpg", { type: blob.type});
        console.log("得到有效的 imageFile:", imageFile);
        currentImageFile = imageFile;
        const reader = new FileReader();
            console.log(reader);
            reader.onload = (event) => {
                const imgC = new Image();
                console.log("success");

                originalImageSrc = event.target.result;
                imgC.src = originalImageSrc;
                imgC.onload = (event) => {
                    img = imgC;
                }
            };
            reader.readAsDataURL(currentImageFile);
        }, croppedImg.type);

  };
  rotatedImg.src = tempCanvas.toDataURL();
}

function drawImageToMainCanvas() {
  // 画布大小和图片一致
  canvas.width = calculate(img.width);
  canvas.height = calculate(img.height);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
}

    // 裁剪
    let startX, startY, endX, endY, isDragging = false;
    let displayScale = 1; // 显示比例（原始图到cropCanvas的缩放）
    const cropOverlay = document.getElementById("cropOverlay");
    const cropCanvas = document.getElementById("cropCanvas");
    const cropCtx = cropCanvas.getContext("2d");
    const cropDoneBtn = document.getElementById("cropDoneBtn");

    cropBtn.addEventListener("click", () => {
      
      if (!img.src) return;
      cropOverlay.style.display = "flex";

      // 弹窗里等比缩放适应高度
      displayScale = (window.innerHeight * 0.8) / img.height;
      cropCanvas.width = img.width * displayScale;
      cropCanvas.height = img.height * displayScale;
      cropCtx.drawImage(img, 0, 0, cropCanvas.width, cropCanvas.height);

      // 拖拽绘制矩形
      cropCanvas.onmousedown = e => {
        isDragging = true;
        startX = e.offsetX;
        startY = e.offsetY;
      };

      cropCanvas.onmousemove = e => {
  if (!isDragging) return;
  endX = e.offsetX;
  endY = e.offsetY;

  // 1. 先画整张图
  cropCtx.drawImage(img, 0, 0, cropCanvas.width, cropCanvas.height);

  // 2. 再画遮罩
  cropCtx.fillStyle = "rgba(0,0,0,0.5)";
  cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);

  // 3. 选区
  let x = Math.min(startX, endX);
  let y = Math.min(startY, endY);
  let w = Math.abs(endX - startX);
  let h = Math.abs(endY - startY);

  // 把选区部分再画一遍原图
  cropCtx.drawImage(
    img,
    x / displayScale, y / displayScale, w / displayScale, h / displayScale, // 原图区域
    x, y, w, h // 在 cropCanvas 上的区域
  );

  // 画边框
  cropCtx.strokeStyle = "red";
  cropCtx.lineWidth = 2;
  cropCtx.strokeRect(x, y, w, h);
};

      cropCanvas.onmouseup = e => {
        isDragging = false;
        endX = e.offsetX;
        endY = e.offsetY;
      };
    });

    // 裁剪完成
    cropDoneBtn.addEventListener("click", () => {
      let x = Math.min(startX, endX) / displayScale;
      let y = Math.min(startY, endY) / displayScale;
      let w = Math.abs(endX - startX) / displayScale;
      let h = Math.abs(endY - startY) / displayScale;

      // 从原始图像裁剪，避免模糊
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = w;
      tempCanvas.height = h;
      const tctx = tempCanvas.getContext("2d");
      tctx.drawImage(img, x, y, w, h, 0, 0, w, h);

      const croppedImg = new Image();
      croppedImg.onload = () => {
        img = croppedImg;
        rotation = 0;
        drawImageToMainCanvas();
        console.log("得到裁剪后的imageFile（未经过转换）:",img.width,img.height);
        // const imageFile = new File([croppedImg], "575.jpg", { type: croppedImg.type });
        // console.log("得到 imageFile:", imageFile);
        // currentImageFile = imageFile;
        // 假设 mainCanvas 是绘制了裁剪后图像的画布
        const mainCanvas = document.getElementById('canvasOverlay');
        
        // 从画布获取 Blob 对象，再创建 File
        mainCanvas.toBlob(blob => {
        const imageFile = new File([blob], "575.jpg", { type: blob.type});
        console.log("得到有效的 imageFile:", imageFile);
        currentImageFile = imageFile;
        const reader = new FileReader();
            console.log(reader);
            reader.onload = (event) => {
                const imgC = new Image();
                console.log("success");

                originalImageSrc = event.target.result;
                imgC.src = originalImageSrc;
                imgC.onload = (event) => {
                    img = imgC;
                }
            };
            reader.readAsDataURL(currentImageFile);
        }, croppedImg.type);

        
      };
      croppedImg.src = tempCanvas.toDataURL();

      cropOverlay.style.display = "none";
    });

    // 导出
    exportBtn.addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "edited.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    // let correctInfo = null;
    // let currentImageFile = null; // 当前处理的图片文件
    // // 发送按钮点击时加载原始图片并显示
    // document.getElementById('sendMessage').addEventListener('click', () => {
    //     const imageFile = document.getElementById('uploadImage').files[0];
    //
    //     if (imageFile) {
    //         // 清空之前的纠正后的图片和信息内容
    //         document.getElementById('imageContainer').innerHTML = ''; // 清空纠正后的图片
    //         const infoContainer = document.getElementById('infoContainer');
    //         infoContainer.innerHTML = ''; // 清空信息内容
    //         infoContainer.style.display = 'none'; // 隐藏 info-container
    //
    //         // 显示原始图片
    //         const reader = new FileReader();
    //         reader.onload = (event) => {
    //             originalImage = event.target.result;
    //             document.getElementById('imageContainer').innerHTML = `<img src="${originalImage}" class="corrected-image">`;
    //         };
    //         reader.readAsDataURL(imageFile);
    //
    //         // 更新当前图片文件
    //         currentImageFile = imageFile;
    //
    //         // 重置开关状态为 off
    //         document.getElementById('myonoffswitch').checked = false;
    //
    //         // 重置状态
    //         correctedImage = null; // 清空纠正后的图片
    //         correctInfo = null; // 清空纠正后的信息
    //         isCorrectedFetched = false; // 重置已获取状态
    //     }
    // });


    // // 监听开关状态变化
    // document.getElementById('myonoffswitch').addEventListener('change', (event) => {
    //     if (event.target.checked) {
    //         // Switch is turned ON
    //         if (currentImageFile === document.getElementById('uploadImage').files[0]) {
    //             // 当前图片与上次处理的图片相同
    //             if (isCorrectedFetched && correctedImage) {
    //                 // 已经获取过纠正后的图片，直接显示
    //                 document.getElementById('imageContainer').innerHTML = `<img src="${correctedImage}" class="corrected-image">`;
    //                 displayCorrectInfo(correctInfo); // 显示信息
    //             } else {
    //                 // 未获取过纠正后的图片，调用API
    //                 fetchCorrectedImage(currentImageFile);
    //             }
    //         } else {
    //             // 当前图片与上次处理的图片不同，需要重新处理
    //             fetchCorrectedImage(currentImageFile);
    //         }
    //     } else {
    //         // Switch is turned OFF, 显示原始图片
    //         if (originalImage) {
    //             document.getElementById('imageContainer').innerHTML = `<img src="${originalImage}" class="corrected-image">`;
    //         }
    //         document.getElementById('infoContainer').style.display = 'none'; // 隐藏 info-container
    //     }
    // });
    //
    // function fetchCorrectedImage(imageFile) {
    //     if (imageFile) {
    //         const formData = new FormData();
    //         formData.append('image', imageFile);
    //
    //         const api = 'http://49.52.27.15:5000/img_correct';
    //
    //         // 清空上一个纠正后的图片和信息
    //         correctedImage = null;
    //         correctInfo = null;
    //
    //         fetch(api, {
    //             method: 'POST',
    //             body: formData,
    //         })
    //             .then(response => response.json())
    //             .then(data => {
    //                 console.log(data);
    //                 correctInfo = data.correct_info;

    //                 // correctedImage = `http://49.52.27.15:5000/temp_images/temp_corrected_image.png`; // 构建完整 URL
    //                 // isCorrectedFetched = true;
    //                 //
    //                 // // 显示纠正后的图片
    //                 // document.getElementById('imageContainer').innerHTML = `<img src="${correctedImage}" class="corrected-image">`;
    //                 // displayCorrectInfo(data.correct_info); // 显示信息
    //             })
    //             .catch(error => {
    //                 console.error('Error:', error);
    //                 alert('图像纠错时出现错误，请重试！');
    //                 // Turn off the switch if there is an error
    //                 document.getElementById('myonoffswitch').checked = false;
    //             });
    //     }
    // }
    // function displayCorrectInfo(correctInfo) {
    //     const infoContainer = document.getElementById("infoContainer");
    //     infoContainer.innerHTML = ''; // 清空之前的内容
    //     infoContainer.style.display = 'block'; // 显示 info-container
    //
    //     // 遍历 correct_info 并生成 HTML 内容
    //     correctInfo.forEach(item => {
    //         const infoItem = document.createElement("div");
    //         infoItem.className = "info-item";
    //         infoItem.innerHTML = `${item.correct_id}. "${item.img_mark_type}", "${item.modify_result}"`;
    //         infoContainer.appendChild(infoItem);
    //     });
    // }
 // ****************以下为测试
//  window.onload = function () {
        
//         //  document.getElementById('imageContainer').innerHTML = `<img src="${originalImageSrc}"  id="originalImage" class="corrected-image">`;
//         // *****************************ls
        
//         const img = new Image();
//         img.src =  originalImageSrc;

//         img.onload = function() {
//           // 设置 canvas 的宽高和图片一致
//           canvas.width = img.width;
//           canvas.height = img.height;

//          // 将图片绘制到 canvas 上
//           ctx.drawImage(img, 0, 0);
          
//         };
//  };
        // **************************/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQ
</script>
</body>
</html>